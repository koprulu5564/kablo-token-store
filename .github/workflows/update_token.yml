name: Update Token
on:
  workflow_dispatch: # Manuel çalıştırma
  schedule:
    - cron: '0 */24 * * *' # 24 saatte bir

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run PHP Script
        uses: php-actions/php@v6
        with:
          php_version: '8.2'
          script: |
            <?php
            // 1. Token'ı API'den çek
            $ch = curl_init("https://core-api.kablowebtv.com/api/channels");
            curl_setopt_array($ch, [
                CURLOPT_HTTPHEADER => [
                    "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                ],
                CURLOPT_RETURNTRANSFER => true
            ]);
            $response = curl_exec($ch);
            $data = json_decode($response, true);

            // 2. Token'ı parse et
            if (isset($data["Data"]["AllChannels"][0]["StreamData"]["HlsStreamUrl"])) {
                preg_match('/wmsAuthSign=([^&]+)/', $data["Data"]["AllChannels"][0]["StreamData"]["HlsStreamUrl"], $matches);
                file_put_contents("token.txt", $matches[1]);
                echo "Token güncellendi!";
            } else {
                throw new Exception("Token alınamadı!");
            }
            ?>

      - name: Commit & Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add token.txt
          git commit -m "Token updated: $(date +'%Y-%m-%d %H:%M')"
          git push
