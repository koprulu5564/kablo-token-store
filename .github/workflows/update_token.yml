name: Update Kablo Token
on:
  workflow_dispatch: # Manuel tetikleme iÃ§in
  schedule:
    - cron: '0 */24 * * *' # 24 saatte bir

jobs:
  update_token:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Repo'ya yazma izni

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # TÃ¼m Git history'yi Ã§ek

    - name: Setup Python (Token Ã‡ekmek Ä°Ã§in)
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Get Token from API
      id: get_token
      run: |
        python -c '
        import requests
        import re
        import os

        try:
            headers = {
                "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbnYiOiJMSVZFIiwiaXBiIjoiMCIsImNnZCI6IjA5M2Q3MjBhLTUwMmMtNDFlZC1hODBmLTJiODE2OTg0ZmI5NSIsImNzaCI6IlRSS1NUIiwiZGN0IjoiM0VGNzUiLCJkaSI6ImE2OTliODNmLTgyNmItNGQ5OS05MzYxLWM4YTMxMzIxOGQ0NiIsInNnZCI6Ijg5NzQxZmVjLTFkMzMtNGMwMC1hZmNkLTNmZGFmZTBiNmEyZCIsInNwZ2QiOiIxNTJiZDUzOS02MjIwLTQ0MjctYTkxNS1iZjRiZDA2OGQ3ZTgiLCJpY2giOiIwIiwiaWRtIjoiMCIsImlhIjoiOjpmZmZmOjEwLjAuMC4yMDYiLCJhcHYiOiIxLjAuMCIsImFibiI6IjEwMDAiLCJuYmYiOjE3NDUxNTI4MjUsImV4cCI6MTc0NTE1Mjg4NSwiaWF0IjoxNzQ1MTUyODI1fQ.OSlafRMxef4EjHG5t6TqfAQC7y05IiQjwwgf6yMUS9E"
            }
            response = requests.get("https://core-api.kablowebtv.com/api/channels", headers=headers)
            response.raise_for_status()

            stream_url = response.json()["Data"]["AllChannels"][0]["StreamData"]["HlsStreamUrl"]
            token = re.search(r"wmsAuthSign=([^&]+)", stream_url).group(1)
            
            with open("token.txt", "w") as f:
                f.write(token)
            
            print(f"::set-output name=token::{token}")
        except Exception as e:
            print(f"::error::Token alÄ±namadÄ±: {str(e)}")
            exit(1)
        '

    - name: Commit and Push Changes
      if: steps.get_token.outputs.token
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Dosya yoksa oluÅŸtur (ilk Ã§alÄ±ÅŸtÄ±rmada gerekli)
        if [ ! -f "token.txt" ]; then
          echo "Ä°lk token oluÅŸturuluyor..."
          echo "${{ steps.get_token.outputs.token }}" > token.txt
        fi

        git add token.txt
        git commit -m "ðŸ”‘ Token GÃ¼ncellendi: $(date +'%d.%m.%Y %H:%M')"
        git push
