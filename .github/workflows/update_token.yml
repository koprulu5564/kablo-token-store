name: ðŸŽ¬ KABLO TV - Token GÃ¼ncelleme
on: 
  workflow_dispatch: # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in ZORUNLU
  schedule:
    - cron: '0 */6 * * *' # 6 saatte bir

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: ðŸ› ï¸ Repoyu Ã‡ek
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # TÃ¼m geÃ§miÅŸi Ã§ek

    - name: ðŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ðŸ”‘ Token Ä°ÅŸlemi (PHP MantÄ±ÄŸÄ±)
      run: |
        if [ ! -f "stream_token.txt" ]; then
          echo '{"token":"INITIAL_TOKEN","expiry":0}' > stream_token.txt
        fi
        
        python -c '
import requests, re, json, time
try:
    with open("stream_token.txt","r") as f:
        data = json.load(f)
        if time.time() < data["expiry"]:
            print("â³ ZamanÄ± dolmamÄ±ÅŸ token var")
            exit(0)

    headers = {
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "User-Agent": "Mozilla/5.0"
    }
    r = requests.get("https://core-api.kablowebtv.com/api/channels", headers=headers, timeout=10)
    r.raise_for_status()
    
    stream_url = r.json()["Data"]["AllChannels"][0]["StreamData"]["HlsStreamUrl"]
    token = re.search(r"wmsAuthSign=([^&]+)", stream_url).group(1)
    
    with open("stream_token.txt","w") as f:
        json.dump({"token":token,"expiry":time.time()+21600},f) # 6 saat
    print("âœ… Token gÃ¼ncellendi: "+token)
except Exception as e:
    print(f"âŒ Hata: {e}")
    exit(1)
        '

    - name: ðŸ’¾ GitHub'a GÃ¶nder
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add stream_token.txt
        git commit -m "ðŸ”„ Token yenilendi: $(date +'%d.%m.%Y %H:%M')"
        git push
