name: 🔑 Update Kablo Token
on:
  workflow_dispatch:  # Manuel çalıştırma için
  schedule:
    - cron: '0 */24 * * *'  # 24 saatte bir

jobs:
  update_token:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: 🛠️ Checkout repo
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 📦 Install dependencies
      run: pip install requests

    - name: 🔄 Fetch Token
      run: |
        python -c '
        import requests, re
        try:
            headers = {"Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}
            response = requests.get("https://core-api.kablowebtv.com/api/channels", headers=headers)
            response.raise_for_status()
            token = re.search(r"wmsAuthSign=([^&]+)", response.json()["Data"]["AllChannels"][0]["StreamData"]["HlsStreamUrl"]).group(1)
            with open("token.txt", "w") as f:
                f.write(token)
            print("✅ Token saved!")
        except Exception as e:
            print(f"❌ Error: {e}")
            exit(1)
        '

    - name: 💾 Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add token.txt
        git commit -m "🔄 Auto-update token: $(date +'%d.%m.%Y %H:%M')"
        git push
