name: üîÑ Update Kablo Token
on:
  workflow_dispatch: # Manuel √ßalƒ±≈ütƒ±rma i√ßin
  schedule:
    - cron: '0 */24 * * *' # 24 saatte bir

jobs:
  update_token:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Repo'ya yazma izni

    steps:
    - name: üõ†Ô∏è Checkout repo
      uses: actions/checkout@v4

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üì¶ Install dependencies
      run: pip install requests

    - name: üîë Fetch Token (Hata D√ºzeltmeli)
      run: |
        python -c '
import requests, re, os
try:
    # API isteƒüi
    headers = {"Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbnYiOiJMSVZFIiwiaXBiIjoiMCIsImNnZCI6IjA5M2Q3MjBhLTUwMmMtNDFlZC1hODBmLTJiODE2OTg0ZmI5NSIsImNzaCI6IlRSS1NUIiwiZGN0IjoiM0VGNzUiLCJkaSI6ImE2OTliODNmLTgyNmItNGQ5OS05MzYxLWM4YTMxMzIxOGQ0NiIsInNnZCI6Ijg5NzQxZmVjLTFkMzMtNGMwMC1hZmNkLTNmZGFmZTBiNmEyZCIsInNwZ2QiOiIxNTJiZDUzOS02MjIwLTQ0MjctYTkxNS1iZjRiZDA2OGQ3ZTgiLCJpY2giOiIwIiwiaWRtIjoiMCIsImlhIjoiOjpmZmZmOjEwLjAuMC4yMDYiLCJhcHYiOiIxLjAuMCIsImFibiI6IjEwMDAiLCJuYmYiOjE3NDUxNTI4MjUsImV4cCI6MTc0NTE1Mjg4NSwiaWF0IjoxNzQ1MTUyODI1fQ.OSlafRMxef4EjHG5t6TqfAQC7y05IiQjwwgf6yMUS9E"}
    response = requests.get("https://core-api.kablowebtv.com/api/channels", headers=headers, timeout=10)
    response.raise_for_status()
    
    # Token √ßekme
    stream_url = response.json()["Data"]["AllChannels"][0]["StreamData"]["HlsStreamUrl"]
    token = re.search(r"wmsAuthSign=([^&]+)", stream_url).group(1)
    
    # Dosyaya yaz
    with open("token.txt", "w") as f:
        f.write(token)
    print("‚úÖ Token ba≈üarƒ±yla alƒ±ndƒ±!")
except Exception as e:
    print(f"‚ùå HATA: {str(e)}")
    if not os.path.exists("token.txt"):
        with open("token.txt", "w") as f:
            f.write("DEFAULT_TOKEN") # Fallback
        print("‚ö†Ô∏è Ge√ßici token olu≈üturuldu")
    exit(1)
        '

    - name: üíæ Commit & Push
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add token.txt
        git commit -m "üîÑ Token updated: $(date +'%d.%m.%Y %H:%M')"
        git push
